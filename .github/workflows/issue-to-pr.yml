name: Convert Issue to PR

on:
  issues:
    types: [edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check and parse issue
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels || [];
            const labelNames = labels.map(l => l.name);
            console.log('Issue labels:', labelNames);
            
            const body = context.payload.issue.body || '';
            console.log('Issue body length:', body.length);
            
            // 检查是否有 content-edit 标签或相关字段
            const hasContentEdit = labelNames.includes('content-edit');
            const hasFileField = body.includes('Which file do you want to edit');
            
            if (!hasContentEdit && !hasFileField) {
              console.log('Skipping: not a content-edit issue');
              core.setOutput('should_run', 'false');
              return;
            }
            
            // 提取文件路径
            const filePatterns = [
              /###\s*Which file do you want to edit\?\s*\n\s*([^\n]+)/i,
              /###\s*Which file do you want to edit\?\s*\n\n\s*([^\n]+)/i,
              /Prefilled Content from `([^`]+)`/i
            ];
            
            let filePath = null;
            for (const pattern of filePatterns) {
              const match = body.match(pattern);
              if (match && match[1]) {
                filePath = match[1].trim();
                break;
              }
            }
            
            // 提取编辑后的内容（在代码块中）
            const contentMatch = body.match(/```markdown\s*\n([\s\S]*?)\n```/);
            const newContent = contentMatch ? contentMatch[1] : null;
            
            if (!filePath) {
              console.error('No file path found');
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: '❌ Cannot find file path in issue. Please make sure the format is correct.'
              });
              core.setOutput('should_run', 'false');
              return;
            }
            
            if (!newContent) {
              console.error('No content found in markdown block');
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: '❌ Cannot find edited content. Please make sure to edit the content in the markdown code block.'
              });
              core.setOutput('should_run', 'false');
              return;
            }
            
            console.log('✅ File path:', filePath);
            console.log('✅ New content length:', newContent.length);
            
            core.setOutput('filePath', filePath);
            core.setOutput('newContent', newContent);
            core.setOutput('should_run', 'true');

      - name: Checkout repository
        if: steps.parse.outputs.should_run == 'true'
        uses: actions/checkout@v4

      - name: Read original file and preserve front matter
        if: steps.parse.outputs.should_run == 'true'
        id: prepare
        run: |
          FILE="${{ steps.parse.outputs.filePath }}"
          
          if [ ! -f "$FILE" ]; then
            echo "File not found: $FILE"
            echo "has_frontmatter=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 检查是否有 front matter
          if head -n 1 "$FILE" | grep -q "^---$"; then
            echo "has_frontmatter=true" >> $GITHUB_OUTPUT
            # 提取 front matter (使用 Python，注意缩进)
            python3 <<'PY' >> $GITHUB_OUTPUT
import sys
with open("${{ steps.parse.outputs.filePath }}", 'r', encoding='utf-8') as f:
    content = f.read()
if content.strip().startswith('---'):
    parts = content.split('\n---\n', 2)
    if len(parts) >= 3:
        front_matter = parts[1]
        print("frontmatter<<EOF")
        print(front_matter)
        print("EOF")
PY
          else
            echo "has_frontmatter=false" >> $GITHUB_OUTPUT
          fi

      - name: Create new file content
        if: steps.parse.outputs.should_run == 'true'
        run: |
          FILE="${{ steps.parse.outputs.filePath }}"
          
          # 使用 Python 来创建新文件（避免 heredoc 问题）
          python3 <<'PYSCRIPT'
import sys
import os

file_path = "${{ steps.parse.outputs.filePath }}"
new_content = """${{ steps.parse.outputs.newContent }}"""
has_frontmatter = "${{ steps.prepare.outputs.has_frontmatter }}" == "true"
front_matter = """${{ steps.prepare.outputs.frontmatter }}"""

# 读取原文件以获取 front matter
if has_frontmatter and os.path.exists(file_path):
    with open(file_path, 'r', encoding='utf-8') as f:
        original = f.read()
    if original.strip().startswith('---'):
        parts = original.split('\n---\n', 2)
        if len(parts) >= 3:
            # 保留 front matter，替换正文
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write('---\n')
                f.write(parts[1])
                f.write('\n---\n')
                f.write(new_content)
            print(f"✅ Updated {file_path} with front matter preserved")
            sys.exit(0)

# 没有 front matter 或无法解析，直接写入新内容
with open(file_path, 'w', encoding='utf-8') as f:
    f.write(new_content)
print(f"✅ Updated {file_path}")
PYSCRIPT

      - name: Create Pull Request
        if: steps.parse.outputs.should_run == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update ${{ steps.parse.outputs.filePath }} via issue #${{ github.event.issue.number }}"
          title: "Update ${{ steps.parse.outputs.filePath }}"
          body: |
            This PR was automatically created from issue #${{ github.event.issue.number }}.
            
            **Changes:**
            - Updated `${{ steps.parse.outputs.filePath }}`
            
            Please review and merge if everything looks good.
            
            ---
            Closes #${{ github.event.issue.number }}
          branch: "content-edit-issue-${{ github.event.issue.number }}"
          delete-branch: true
          labels: content-edit

