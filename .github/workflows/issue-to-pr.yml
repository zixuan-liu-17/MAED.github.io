name: Convert Issue to PR

on:
  issues:
    types: [edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Check and parse issue
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels?.map(l => l.name) || [];
            const body = context.payload.issue.body || '';

            const hasContentEdit = labels.includes('content-edit') || body.includes('Which file do you want to edit');
            if (!hasContentEdit) {
              core.setOutput('should_run', 'false');
              return;
            }

            const filePatterns = [
              /###\s*Which file do you want to edit\?\s*\n\s*([^\n]+)/i,
              /Prefilled Content from `([^`]+)`/i
            ];
            let filePath = null;
            for (const p of filePatterns) {
              const m = body.match(p);
              if (m && m[1]) { filePath = m[1].trim(); break; }
            }

            const contentMatch = body.match(/```markdown\s*\n([\s\S]*?)\n```/);
            const newContent = contentMatch ? contentMatch[1] : null;

            if (!filePath || !newContent) {
              core.setOutput('should_run', 'false');
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: "❌ Cannot parse file path or content from the issue body."
              });
              return;
            }

            core.setOutput('filePath', filePath);
            core.setOutput('newContent', newContent);
            core.setOutput('should_run', 'true');

      - name: Checkout repository
        if: steps.parse.outputs.should_run == 'true'
        uses: actions/checkout@v4

      - name: Read and extract front matter (safe mode)
        if: steps.parse.outputs.should_run == 'true'
        id: prepare
        shell: bash
        run: |
          FILE="${{ steps.parse.outputs.filePath }}"
          echo "Processing $FILE"

          if [ ! -f "$FILE" ]; then
            echo "has_frontmatter=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if head -n 1 "$FILE" | grep -q "^---$"; then
            echo "has_frontmatter=true" >> "$GITHUB_OUTPUT"

            # 安全的 Python 单行解析（无 heredoc）
            python3 -c "
            import re, sys
            path = '${{ steps.parse.outputs.filePath }}'
            text = open(path, encoding='utf-8').read()
            m = re.match(r'^---\\n(.*?)\\n---\\n', text, re.S)
            if m: print(m.group(1))
            " > frontmatter.txt

            {
              echo 'frontmatter<<EOF'
              cat frontmatter.txt
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            echo "has_frontmatter=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create new file content
        if: steps.parse.outputs.should_run == 'true'
        run: |
          FILE="${{ steps.parse.outputs.filePath }}"
          echo "Updating file: $FILE"

          if [ "${{ steps.prepare.outputs.has_frontmatter }}" = "true" ]; then
            {
              echo "---"
              echo "${{ steps.prepare.outputs.frontmatter }}"
              echo "---"
              echo ""
              echo "${{ steps.parse.outputs.newContent }}"
            } > "$FILE"
          else
            echo "${{ steps.parse.outputs.newContent }}" > "$FILE"
          fi

          echo "✅ File updated successfully"

      - name: Create Pull Request
        if: steps.parse.outputs.should_run == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update ${{ steps.parse.outputs.filePath }} via issue #${{ github.event.issue.number }}"
          title: "Update ${{ steps.parse.outputs.filePath }}"
          body: |
            This PR was automatically created from issue #${{ github.event.issue.number}}.

            **Changes:**
            - Updated `${{ steps.parse.outputs.filePath }}`

            Please review and merge if everything looks good.

            ---
            Closes #${{ github.event.issue.number}}
          branch: "content-edit-issue-${{ github.event.issue.number }}"
          delete-branch: true
          labels: content-edit
